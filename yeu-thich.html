<!DOCTYPE html>
<html lang="vi">

<head>
    <script src="settings.js"></script>
    <script src="protection.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Công cụ yêu thích - Máy tính Y học</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <meta name="theme-color" content="#0d9488">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="manifest" href="/manifest.json">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { primary: '#0ea5e9', secondary: '#14b8a6' },
                    animation: { 'float': 'float 6s ease-in-out infinite' },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- CHẶN BÔI ĐEN (SELECTION) --- */
        body {
            -webkit-tap-highlight-color: transparent;
            touch-action: pan-x pan-y;
            overscroll-behavior-y: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .bg-pattern {
            background-color: #f8fafc;
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 24px 24px;
        }

        input {
            -webkit-user-select: text !important;
            user-select: text !important;
            cursor: auto;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* --- HIỆU ỨNG TIM VỠ --- */
        @keyframes heartbreak {
            0% {
                transform: scale(1);
                color: #f43f5e;
            }

            40% {
                transform: scale(1.3) rotate(-15deg);
                color: #be123c;
            }

            60% {
                transform: scale(1.3) rotate(15deg);
            }

            100% {
                transform: scale(0) rotate(0deg);
                opacity: 0;
            }
        }

        .animate-heartbreak {
            /* Tăng tốc độ animation: 0.3s */
            animation: heartbreak 0.3s ease-in-out forwards;
        }
    </style>
</head>

<body
    class="text-slate-800 bg-pattern min-h-screen pb-24 md:pb-8 overflow-x-hidden selection:bg-primary selection:text-white">

    <div
        class="fixed top-0 left-0 w-full h-96 bg-gradient-to-b from-blue-50/80 to-transparent -z-10 pointer-events-none">
    </div>
    <div
        class="fixed -top-20 -right-20 w-96 h-96 bg-blue-100/50 rounded-full blur-3xl -z-10 pointer-events-none mix-blend-multiply animate-float">
    </div>
    <div class="fixed top-1/2 -left-20 w-80 h-80 bg-teal-100/40 rounded-full blur-3xl -z-10 pointer-events-none mix-blend-multiply animate-float"
        style="animation-delay: 2s;"></div>
    <div class="fixed bottom-0 right-0 w-96 h-96 bg-purple-100/40 rounded-full blur-3xl -z-10 pointer-events-none mix-blend-multiply animate-float"
        style="animation-delay: 4s;"></div>

    <main class="md:pt-20 p-3 md:p-6 max-w-6xl mx-auto min-h-screen">

        <div class="md:hidden pt-2 pb-4 flex items-center justify-between relative z-20">
            <div>
                <h2 class="text-xs text-slate-500 font-bold uppercase tracking-widest mb-1 text-dark-muted">Trang cá
                    nhân</h2>
                <h1
                    class="text-2xl font-extrabold bg-gradient-to-r from-pink-500 to-rose-500 bg-clip-text text-transparent">
                    Công cụ đã thích</h1>
            </div>
            <button onclick="window.location.reload()"
                class="w-10 h-10 flex items-center justify-center rounded-xl bg-white shadow-sm border border-slate-100 text-slate-500 hover:text-blue-600 active:scale-95 transition">
                <i class="fa-solid fa-rotate-right"></i>
            </button>
        </div>

        <div class="sticky top-0 md:top-20 z-40 -mx-3 px-3 md:mx-0 md:px-0 py-3 mb-6 transition-all duration-300"
            id="search-container">
            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none z-10">
                    <i
                        class="fa-solid fa-magnifying-glass text-slate-400 group-focus-within:text-rose-500 transition-colors"></i>
                </div>
                <input type="text" id="search-input" onkeyup="filterTools()"
                    placeholder="Tìm trong danh sách yêu thích..."
                    class="w-full pl-11 pr-4 py-3.5 rounded-2xl border-none shadow-[0_4px_20px_-4px_rgba(0,0,0,0.1)] bg-white/95 backdrop-blur-xl focus:ring-2 focus:ring-rose-500/50 focus:outline-none text-slate-700 text-base placeholder:text-slate-400 transition-all">
            </div>
        </div>

        <div id="loading-state" class="flex flex-col items-center justify-center pt-20 text-slate-400">
            <i class="fa-solid fa-spinner fa-spin text-3xl mb-4 text-rose-500"></i>
            <p>Đang tải dữ liệu...</p>
        </div>

        <div id="login-required" class="hidden flex-col items-center justify-center pt-10 text-center px-4">
            <div class="w-24 h-24 bg-rose-50 rounded-full flex items-center justify-center mb-6 animate-float">
                <i class="fa-solid fa-lock text-4xl text-rose-500"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">Bạn chưa đăng nhập</h3>
            <p class="text-slate-500 mb-8 max-w-sm">Vui lòng đăng nhập để xem và quản lý danh sách các công cụ y học yêu
                thích của bạn.</p>
            <button onclick="requestLogin()"
                class="px-6 py-3 rounded-xl bg-gradient-to-r from-rose-500 to-pink-500 text-white font-semibold shadow-lg shadow-rose-500/30 active:scale-95 transition hover:scale-105">
                Đăng nhập ngay
            </button>
        </div>

        <div id="empty-favorites" class="hidden flex-col items-center justify-center pt-10 text-center px-4">
            <div class="w-24 h-24 bg-slate-100 rounded-full flex items-center justify-center mb-6">
                <i class="fa-regular fa-heart text-4xl text-slate-400"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">Chưa có mục yêu thích</h3>
            <p class="text-slate-500 mb-8 max-w-sm">Hãy thả tim các công cụ bạn hay dùng để truy cập nhanh hơn nhé.</p>
            <a href="cong-cu.html"
                class="px-6 py-3 rounded-xl bg-white border border-slate-200 text-slate-600 font-semibold hover:bg-slate-50 transition">
                Khám phá công cụ
            </a>
        </div>

        <div id="favorites-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 hidden">
        </div>

    </main>

    <script src="tools-data.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAIhH7oLBX9eG5GvdhDJ4YemvoPwltIMis",
            authDomain: "may-tinh-y-hoc.firebaseapp.com",
            projectId: "may-tinh-y-hoc",
            storageBucket: "may-tinh-y-hoc.firebasestorage.app",
            messagingSenderId: "407413077096",
            appId: "1:407413077096:web:580342bd72f2758ceab7dd",
            measurementId: "G-QFRDTFYLDH"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loadingState = document.getElementById('loading-state');
        const loginRequired = document.getElementById('login-required');
        const container = document.getElementById('favorites-container');
        const emptyState = document.getElementById('empty-favorites');

        // --- HÀM HỖ TRỢ LẤY DỮ LIỆU GỐC TỪ FILE JS ---
        function getLatestToolData(toolId) {
            // toolsLibrary được load từ file tools-data.js
            if (typeof toolsLibrary === 'undefined') return null;

            // Duyệt qua tất cả category để tìm tool có id tương ứng
            for (const category of toolsLibrary) {
                if (category.items) {
                    const found = category.items.find(item => item.id === toolId);
                    if (found) return found;
                }
            }
            return null;
        }

        // --- HÀM ĐĂNG NHẬP TRỰC TIẾP ---
        window.requestLogin = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                if (error.code !== 'auth/popup-closed-by-user' && error.code !== 'auth/cancelled-popup-request') {
                    console.error("Login Error:", error);
                    alert("Đăng nhập thất bại: " + error.message);
                }
            }
        };

        function renderFavorites(favorites) {
            container.innerHTML = '';

            if (!favorites || favorites.length === 0) {
                emptyState.classList.remove('hidden');
                emptyState.classList.add('flex');
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            emptyState.classList.add('hidden');
            emptyState.classList.remove('flex');

            favorites.forEach(favItem => {
                // 1. Lấy thông tin mới nhất từ source code (tools-data.js)
                const latestData = getLatestToolData(favItem.id);

                // 2. Hợp nhất
                const toolToRender = latestData ? { ...favItem, ...latestData } : favItem;

                createCard(toolToRender);
            });
        }

        function createCard(tool) {
            const card = document.createElement('div');
            card.id = `card-${tool.id}`;
            // UPDATE: Sử dụng class giống hệt cong-cu.html
            card.className = "tool-card group bg-white p-4 rounded-2xl shadow-sm hover:shadow-[0_8px_30px_-5px_rgba(0,0,0,0.1)] border border-slate-100 cursor-pointer flex items-center gap-4 transition-all duration-300 hover:-translate-y-1 relative overflow-hidden";

            const kw = (tool.keywords || '') + ' ' + (tool.name || '');
            card.setAttribute('data-name', (tool.name || '').toLowerCase());
            card.setAttribute('data-keywords', kw.toLowerCase());

            card.onclick = (e) => {
                if (!e.target.closest('.fav-btn')) {
                    useTool(tool.id, tool.name, tool.icon, tool.color, tool.url);
                }
            };

            const color = tool.color || 'blue';
            const iconVal = tool.icon || 'fa-stethoscope';

            let iconHtml = '';
            if (iconVal.includes('/') || iconVal.includes('.')) {
                iconHtml = `<img src="${iconVal}" class="w-8 h-8 object-contain" alt="icon">`;
            } else if (iconVal.includes('fa-')) {
                iconHtml = `<i class="fa-solid ${iconVal}"></i>`;
            } else {
                iconHtml = `<span class="text-2xl">${iconVal}</span>`;
            }

            // UPDATE HTML STRUCTURE: Đồng bộ với tools-data.js (Icon to hơn, chữ to hơn)
            card.innerHTML = `
                <button onclick="handleLocalHeartClick(this, '${tool.id}', '${tool.name}', '${tool.url}', '${tool.icon}', '${tool.color}')" 
                    class="fav-btn absolute top-2 right-2 z-30 w-8 h-8 rounded-full bg-white/60 backdrop-blur-sm hover:bg-white shadow-sm border border-white/50 flex items-center justify-center group/btn transition-all">
                    <i class="fa-solid fa-heart text-rose-500"></i>
                </button>

                <div class="absolute top-0 right-0 w-12 h-12 bg-${color}-50 rounded-bl-full -mr-6 -mt-6 transition-all group-hover:bg-${color}-100"></div>

                <div class="w-14 h-14 flex-shrink-0 rounded-xl bg-gradient-to-br from-${color}-50 to-${color}-100 flex items-center justify-center text-${color}-500 text-2xl shadow-inner group-hover:scale-110 transition-transform">
                    ${iconHtml}
                </div>
                
                <div class="overflow-hidden relative z-10 flex-1 pr-6">
                    <h4 class="font-semibold text-slate-700 text-base md:text-base truncate group-hover:text-${color}-600 transition-colors">
                        ${tool.name}
                    </h4>
                    <p class="text-sm md:text-xs text-slate-400 truncate mt-0.5">${tool.desc || tool.description || 'Công cụ tính toán y học'}</p>
                </div>
            `;
            container.appendChild(card);
        }

        onAuthStateChanged(auth, async (user) => {
            loadingState.classList.add('hidden');

            if (!user) {
                loginRequired.classList.remove('hidden');
                loginRequired.classList.add('flex');
                container.classList.add('hidden');
                emptyState.classList.add('hidden');
            } else {
                loginRequired.classList.add('hidden');
                loginRequired.classList.remove('flex');

                try {
                    const docRef = doc(db, "users", user.uid);
                    const docSnap = await getDoc(docRef);
                    const favorites = docSnap.exists() ? (docSnap.data().favorites || []) : [];
                    renderFavorites(favorites);
                } catch (e) {
                    console.error("Lỗi tải dữ liệu:", e);
                }
            }
        });
    </script>

    <script>
        // --- XỬ LÝ CLICK TIM: HIỆU ỨNG TIM VỠ & BIẾN MẤT NHANH ---
        async function handleLocalHeartClick(btn, id, name, url, icon, color) {
            const card = document.getElementById(`card-${id}`);
            const iconEl = btn.querySelector('i');

            // 1. Hiệu ứng ngay lập tức: Tim vỡ
            if (iconEl) {
                iconEl.classList.remove('fa-heart');
                iconEl.classList.add('fa-heart-crack');
                iconEl.classList.add('animate-heartbreak');
            }

            try {
                // Gọi hàm xử lý logic xóa trong database
                if (window.toggleFavorite) {
                    await window.toggleFavorite(id, name, url, icon, color);
                }

                // 2. Đợi một chút xíu cho tim bắt đầu vỡ (250ms) sau đó làm mờ thẻ ngay
                setTimeout(() => {
                    if (card) {
                        // Tăng tốc độ biến mất của thẻ (0.2s) và thu nhỏ lại (scale 0.5)
                        card.style.transition = 'all 0.2s ease-out';
                        card.style.opacity = '0';
                        card.style.transform = 'scale(0.5)'; // Thu nhỏ nhanh tạo cảm giác "vút" đi

                        // 3. Sau khi thẻ đã mờ hẳn (200ms) thì xóa khỏi DOM
                        setTimeout(() => {
                            card.remove();
                            const container = document.getElementById('favorites-container');
                            // Kiểm tra nếu không còn thẻ nào thì hiện màn hình trống
                            if (container && container.children.length === 0) {
                                document.getElementById('empty-favorites').classList.remove('hidden');
                                document.getElementById('empty-favorites').classList.add('flex');
                            }
                        }, 200); // Khớp với thời gian transition ở trên
                    }
                }, 250); // Thời gian chờ nhìn thấy tim vỡ

            } catch (e) {
                // Nếu lỗi thì khôi phục lại tim đỏ
                if (iconEl) {
                    iconEl.classList.remove('fa-heart-crack', 'animate-heartbreak');
                    iconEl.classList.add('fa-heart');
                }
                console.error(e);
                alert("Không thể xóa yêu thích lúc này.");
            }
        }

        function filterTools() {
            const input = document.getElementById('search-input');
            const filter = input.value.toLowerCase();
            const container = document.getElementById('favorites-container');
            const cards = container.getElementsByClassName('tool-card');

            for (let i = 0; i < cards.length; i++) {
                const name = cards[i].getAttribute('data-name');
                const keywords = cards[i].getAttribute('data-keywords');
                if (name.includes(filter) || keywords.includes(filter)) {
                    cards[i].style.display = "";
                } else {
                    cards[i].style.display = "none";
                }
            }
        }

        function useTool(id, name, icon, color, url) {
            let recentTools = JSON.parse(localStorage.getItem('recentTools')) || [];
            recentTools = recentTools.filter(tool => tool.url !== url && tool.id !== id);
            recentTools.unshift({ id, name, icon, color, url, timestamp: new Date().getTime() });
            if (recentTools.length > 5) recentTools = recentTools.slice(0, 5);
            localStorage.setItem('recentTools', JSON.stringify(recentTools));
            if (url) window.location.href = url;
        }
    </script>

    <script type="module" src="app.js"></script>
</body>

</html>