<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tính toán BMI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Light background color */
        }
        /* Small adjustments for input elements */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* Custom styles from original BMI page, adapted to fit the new aesthetic */
        .input-label {
            font-size: 0.875rem; /* text-sm */
            color: #555; /* Darker label color */
            margin-bottom: 0.25rem; /* Reduced margin */
        }
        .input-field {
            background-color: #f0f2f5; /* Lighter input background, similar to ABG input */
            color: #333; /* Darker input text color */
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.625rem 1rem; /* Adjusted py-2.5 px-4 equivalent */
            font-size: 1rem; /* Standard font size */
            width: 100%; /* Full width for flexibility */
            text-align: center;
        }
        .unit-selector {
            background-color: #f0f2f5; /* Lighter selector background */
            color: #333; /* Darker selector text color */
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.625rem 1rem; /* px-5 py-3 */
            font-size: 1rem; /* text-base */
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23333" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1em;
            cursor: pointer;
            min-width: 70px;
        }

        /* Gender icons and indicator */
        .gender-icon-wrapper {
            position: relative;
            display: flex; /* Use flex to center content */
            flex-direction: column; /* Keep existing layout for indicator */
            align-items: center;
            justify-content: center;
            min-width: 50px; /* Adjusted width for touch target */
            height: 50px; /* Adjusted height */
            border: 1px solid #d1d5db; /* Add border for button look */
            border-radius: 0.5rem; /* Rounded corners */
            cursor: pointer;
            transition: all 0.2s ease-in-out; /* Smooth transition for selection */
            background-color: #f0f2f5; /* Match input field background */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* Subtle shadow */
            padding-top: 2px; /* Adjust padding if needed to center emoji */
        }
        .gender-icon-wrapper:hover {
            background-color: #e2e8f0; /* Light hover effect */
        }
        .gender-icon-wrapper.selected {
            border-color: #4f46e5; /* Highlight border on selection */
            background-color: #eef2ff; /* Light background on selection */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* Slightly stronger shadow */
        }
        .gender-icon {
            font-size: 1.8rem; /* Emoji size */
            color: #9ca3af; /* Default color */
            line-height: 1; /* Ensure emoji is vertically centered */
        }
        .gender-icon-wrapper.selected .gender-icon {
            color: #4f46e5; /* Selected color for emoji */
        }
        .gender-indicator {
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #4f46e5; /* Matches indigo-600 */
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%) translateY(-100%); /* Move up to be outside border */
            display: none;
            transition: opacity 0.2s;
        }
        .gender-icon-wrapper.selected .gender-indicator {
            display: block;
        }

        /* BMI Display Area */
        .bmi-display-area {
            text-align: center;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .bmi-value {
            font-size: 3.5rem;
            font-weight: 600;
            color: #28a745; /* Green for normal BMI */
            margin-top: 0.25rem;
        }
        .bmi-category {
            font-size: 1.25rem;
            color: #28a745; /* Green for normal BMI */
            margin-top: 0.25rem;
        }

        /* Horizontal BMI Chart */
        .bmi-horizontal-chart {
            position: relative;
            width: 100%;
            height: 25px;
            margin-top: 1.5rem;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
            background-color: #dc2626; /* Set background to red to cover potential gaps */
        }
        .bmi-track {
            display: flex;
            width: 100%;
            height: 100%;
        }
        .bmi-segment {
            height: 100%;
            flex-shrink: 0; /* Prevent segments from shrinking */
            flex-grow: 0; /* Prevent segments from growing initially */
        }
        .bmi-pointer-horizontal {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 35px;
            background-color: #333; /* Darker pointer */
            border-radius: 5px;
            transition: left 0.5s ease-out;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .bmi-horizontal-labels {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.8rem;
            color: #777;
            position: relative;
            height: 18px;
        }
        .bmi-horizontal-labels .label-val {
            position: absolute;
            top: 0;
            transform: translateX(-50%);
            white-space: nowrap;
            text-align: center;
        }

        /* Category Table */
        .category-table {
            margin-top: 1.5rem;
            width: 100%;
        }
        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb; /* gray-200 */
        }
        .category-item:last-child {
            border-bottom: none;
        }
        .category-name {
            font-size: 0.95rem;
            color: #333; /* Default text color */
            display: flex;
            align-items: center;
        }
        .category-range {
            font-size: 0.95rem;
            color: #777; /* Default text color */
        }
        .category-item.selected {
            background-color: #eef2ff; /* indigo-50 */
            border-radius: 0.5rem;
            padding-left: 0.75rem;
            padding-right: 0.75rem;
            font-weight: 600; /* Bold the text */
        }
        .category-item.selected.underweight-color .category-name,
        .category-item.selected.underweight-color .category-range {
            color: #60a5fa; /* blue-400 */
        }
        .category-item.selected.normal-color .category-name,
        .category-item.selected.normal-color .category-range {
            color: #16a34a; /* green-600 */
        }
        .category-item.selected.overweight-color .category-name,
        .category-item.selected.overweight-color .category-range {
            color: #ca8a04; /* yellow-600 */
        }
        .category-item.selected.obese-color .category-name,
        .category-item.selected.obese-color .category-range {
            color: #dc2626; /* red-600 */
        }

        .normal-weight-range {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            font-size: 1rem;
            font-weight: 500;
            color: #333;
            padding-top: 0.75rem;
            border-top: 1px solid #e5e7eb; /* gray-200 */
        }

        .reset-button {
            background-color: #6b7280; /* gray-500 */
            color: #fff;
            padding: 0.75rem 2rem;
            border-radius: 9999px; /* rounded-full */
            font-weight: 700;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s transform 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%; /* Make it full width like other buttons */
            margin-top: 1.5rem; /* Spacing from inputs */
        }

        .reset-button:hover {
            background-color: #4b5563; /* gray-700 */
            transform: scale(1.02);
        }

        /* Mobile responsiveness adjustments */
        @media (max-width: 640px) {
            .input-field, .unit-selector {
                padding: 0.375rem 0.5rem; /* py-1.5 px-2 equivalent */
                font-size: 0.9rem;
            }
            .gender-icon-wrapper {
                min-width: 45px; /* Slightly smaller for mobile */
                height: 45px; /* Slightly smaller for mobile */
            }
            .gender-icon {
                font-size: 1.6rem; /* Emoji size for mobile */
            }
            .gender-indicator {
                border-left: 6px solid transparent;
                border-right: 6px solid transparent;
                border-top: 6px solid #4f46e5;
            }
            .bmi-value {
                font-size: 3rem;
            }
            .bmi-category {
                font-size: 1rem;
            }
            .bmi-horizontal-chart {
                height: 20px;
            }
            .bmi-pointer-horizontal {
                width: 8px;
                height: 30px;
            }
            .bmi-horizontal-labels {
                font-size: 0.7rem;
                height: 15px;
            }
            .category-item {
                padding: 0.4rem 0;
            }
            .category-name, .category-range {
                font-size: 0.85rem;
            }
            .reset-button {
                padding: 0.5rem 1rem; /* py-2 px-4 equivalent */
                font-size: 0.9rem;
            }
            .input-item {
                margin-bottom: 0.75rem; /* Adjust margin for mobile inputs */
            }
         /* Fixed header for mobile */
        @media (max-width: 767px) { /* Adjust breakpoint as needed, Tailwind's 'md' is 768px */
            header {
                position: fixed;
                top: 0;
                width: 100%;
                z-index: 1000; /* Ensure header stays on top */
                padding-top: 0.25rem; /* Reduced padding-top for mobile */
                padding-bottom: 0.25rem; /* Reduced padding-bottom for mobile */
            }
            body {
                padding-top: 60px; /* Adjusted padding to prevent content from going under the fixed header */
            }
            /* Further reduce padding for navigation links on mobile */
            .nav-link-mobile-padding {
                padding-top: 0.1rem; /* Smaller top padding */
                padding-bottom: 0.1rem; /* Smaller bottom padding */
            }
            .mobile-nav-margin-fix {
                margin-top: 0;
            }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header Section -->
    <header class="bg-white shadow-md py-4 md:py-4">
        <div class="container mx-auto px-4 flex flex-col md:flex-row justify-between items-center">
            <!-- Logo/Tên trang web (Hidden on mobile, visible on desktop) -->
            <div class="flex items-center mb-4 md:mb-0 hidden md:flex">
                <a href="#" class="text-3xl font-bold text-indigo-700 rounded-lg p-2 transition duration-300 hover:text-indigo-900">
                    Máy tính y học
                </a>
            </div>
            <!-- Navigation Menu -->
            <nav class="flex flex-wrap justify-center space-x-1 md:space-x-4 w-full md:w-auto mobile-nav-margin-fix">
                <a href="index.html" class="text-base font-medium text-gray-700 hover:text-indigo-600 transition duration-300 p-1 rounded-md hover:bg-gray-100 nav-link-mobile-padding">Trang Chủ</a>
                <a href="cong-cu.html" class="text-base font-medium text-gray-700 hover:text-indigo-600 transition duration-300 p-1 rounded-md hover:bg-gray-100 nav-link-mobile-padding">Công Cụ</a>
                <a href="gioi-thieu.html" class="text-base font-medium text-gray-700 hover:text-indigo-600 transition duration-300 p-1 rounded-md hover:bg-gray-100 nav-link-mobile-padding">Giới thiệu</a>
                <a href="#lien-he" class="text-base font-medium text-gray-700 hover:text-indigo-600 transition duration-300 p-1 rounded-md hover:bg-gray-100 nav-link-mobile-padding">Liên Hệ</a>
            </nav>
        </div>
    </header>

    <section class="py-8 md:py-16 bg-white rounded-lg shadow-inner mx-4 my-8 md:mx-auto md:my-12 md:max-w-3xl">
        <div class="container mx-auto px-2 sm:px-4">
            <!-- Back Button and Heading -->
            <a href="cong-cu.html" class="block w-max mb-2 bg-indigo-100 p-1 rounded-full text-indigo-700 hover:bg-indigo-200 transition duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </a>
            <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-8">
                Tính toán BMI
            </h1>

            <div class="bg-gray-50 p-4 sm:p-6 md:p-8 rounded-xl shadow-lg">
                <!-- Combined Input section: Khu vực, Độ tuổi, Giới tính -->
                <div class="flex flex-wrap items-end justify-between top-input-gender-group -mx-1 mb-4">
                    <!-- Khu vực -->
                    <div class="input-item w-1/2 sm:w-1/4 px-1 mb-3">
                        <label for="regionSelect" class="input-label">Khu vực</label>
                        <select id="regionSelect" class="unit-selector w-full">
                            <option value="asia">Châu Á</option>
                            <option value="europe">Châu Âu / Chung</option>
                        </select>
                    </div>
                    <!-- Độ tuổi -->
                    <div class="input-item w-1/2 sm:w-1/4 px-1 mb-3">
                        <label for="age" class="input-label">Độ tuổi</label>
                        <input type="number" id="age" min="1" inputmode="numeric" class="input-field w-full">
                    </div>
                    <!-- Giới tính Nam và Nữ -->
                    <div class="flex items-end justify-center w-full sm:w-1/2 px-1 gender-section mb-3">
                        <div id="maleIconWrapper" class="gender-icon-wrapper selected mr-2">
                            <div id="maleIcon" class="gender-icon">🚹</div>
                            <div id="maleIndicator" class="gender-indicator"></div>
                        </div>
                        <div id="femaleIconWrapper" class="gender-icon-wrapper ml-2">
                            <div id="femaleIcon" class="gender-icon">🚺</div>
                            <div id="femaleIndicator" class="gender-indicator"></div>
                        </div>
                    </div>
                </div>

                <!-- Chiều cao, Cân nặng -->
                <div class="flex flex-wrap mb-4 -mx-1">
                    <div class="input-item w-1/2 px-1">
                        <label for="height" class="input-label">Chiều cao</label>
                        <div class="flex items-center w-full">
                            <input type="number" id="height" min="1" inputmode="numeric" class="input-field flex-grow">
                            <select id="heightUnit" class="unit-selector ml-2">
                                <option value="cm">cm</option>
                                <option value="m">m</option>
                                <option value="in">inch</option>
                            </select>
                        </div>
                    </div>
                    <div class="input-item w-1/2 px-1">
                        <label for="weight" class="input-label">Cân nặng</label>
                        <div class="flex items-center w-full">
                            <input type="number" id="weight" min="1" inputmode="numeric" class="input-field flex-grow">
                            <select id="weightUnit" class="unit-selector ml-2">
                                <option value="kg">kg</option>
                                <option value="lb">lb</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Reset Button -->
                <button id="resetButton" class="reset-button">Nhập lại</button>

                <!-- Always visible: Horizontal BMI Chart -->
                <div class="bmi-display-area">
                    <div class="relative w-full h-8 rounded-xl overflow-hidden shadow-inner bmi-horizontal-chart">
                        <div class="flex w-full h-full bmi-track">
                            <!-- Segments are dynamically added by JS -->
                        </div>
                        <div id="bmiPointer" class="bmi-pointer-horizontal"></div>
                    </div>
                    <div class="flex justify-between w-full mt-2 text-xs text-gray-600 bmi-horizontal-labels">
                        <!-- Labels are dynamically added by JS -->
                    </div>
                    <div class="text-sm text-gray-500 mt-4">BMI</div>

                    <!-- This section will be hidden/shown -->
                    <div id="dynamicResultsContentWrapper" class="hidden">
                        <div id="bmiResult" class="bmi-value">0.0</div> <!-- Color updated by JS -->
                        <div id="bmiCategory" class="bmi-category"></div> <!-- Color updated by JS -->
                    </div>
                </div>

                <!-- Always visible: Category Table -->
                <div class="flex justify-between items-start category-table">
                    <div class="w-1/2 pr-2">
                        <div id="categoryExtremelyUnderweight" class="category-item">
                            <span class="category-name">Cực kỳ Nhẹ cân</span>
                        </div>
                        <div id="categoryVeryUnderweight" class="category-item">
                            <span class="category-name">Rất Nhẹ cân</span>
                        </div>
                        <div id="categoryUnderweight" class="category-item">
                            <span class="category-name">Nhẹ cân</span>
                        </div>
                        <div id="categoryNormal" class="category-item">
                            <span class="category-name">Bình thường</span>
                        </div>
                        <div id="categoryOverweight" class="category-item">
                            <span class="category-name">Thừa cân</span>
                        </div>
                        <div id="categoryObeseClassI" class="category-item">
                            <span class="category-name">Béo phì Loại I</span>
                        </div>
                        <div id="categoryObeseClassII" class="category-item">
                            <span class="category-name">Béo phì Loại II</span>
                        </div>
                        <div id="categoryObeseClassIII" class="category-item">
                            <span class="category-name">Béo phì Loại III</span>
                        </div>
                    </div>
                    <div class="w-1/2 pl-2 text-right">
                        <div id="rangeItemExtremelyUnderweight" class="category-item">
                            <span id="rangeExtremelyUnderweight" class="category-range"></span>
                        </div>
                        <div id="rangeItemVeryUnderweight" class="category-item">
                            <span id="rangeVeryUnderweight" class="category-range"></span>
                        </div>
                        <div id="rangeItemUnderweight" class="category-item">
                            <span id="rangeUnderweight" class="category-range"></span>
                        </div>
                        <div id="rangeItemNormal" class="category-item">
                            <span id="rangeNormal" class="category-range"></span>
                        </div>
                        <div id="rangeItemOverweight" class="category-item">
                            <span id="rangeOverweight" class="category-range"></span>
                        </div>
                        <div id="rangeItemObeseClassI" class="category-item">
                            <span id="rangeObeseClassI" class="category-range"></span>
                        </div>
                        <div id="rangeItemObeseClassII" class="category-item">
                            <span id="rangeObeseClassII" class="category-range"></span>
                        </div>
                        <div id="rangeItemObeseClassIII" class="category-item">
                            <span id="rangeObeseClassIII" class="category-range"></span>
                        </div>
                    </div>
                </div>

                <!-- This section will be hidden/shown -->
                <div id="dynamicIdealWeightRangeContentWrapper" class="hidden">
                    <div class="normal-weight-range">
                        <span>Cân nặng Bình thường</span>
                        <span id="idealWeightRange">... kg</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer id="lien-he" class="bg-gray-800 text-white py-8 text-center rounded-t-lg shadow-inner">
        <div class="container mx-auto px-4">
            <p>&copy; 2025 Máy tính y học. Mọi quyền được bảo lưu.</p>
            <p class="mt-2">
                Liên hệ: BS. Nguyễn Duy Toàn - Bệnh viện đa khoa Lâm Đồng
            </p>
            <p>
                Email: <a href="mailto:toannguyen284@gmail.com" class="text-indigo-400 hover:text-white transition duration-300">toannguyen284@gmail.com</a>
            </p>
            <div class="flex justify-center space-x-4 mt-4">
                <a href="chinh-sach-bao-mat.html" class="text-gray-400 hover:text-white transition duration-300">Chính sách bảo mật</a>
                <a href="dieu-khoan-dich-vu.html" class="text-gray-400 hover:text-white transition duration-300">Điều khoản dịch vụ</a>
            </div>
        </div>
    </footer>
    
    <script>
        // DOM elements
        const ageInput = document.getElementById('age');
        const heightInput = document.getElementById('height');
        const weightInput = document.getElementById('weight');
        const heightUnit = document.getElementById('heightUnit');
        const weightUnit = document.getElementById('weightUnit');
        const regionSelect = document.getElementById('regionSelect');
        const bmiResult = document.getElementById('bmiResult');
        const bmiCategory = document.getElementById('bmiCategory');
        const bmiPointer = document.getElementById('bmiPointer');
        const idealWeightRange = document.getElementById('idealWeightRange');
        const maleIcon = document.getElementById('maleIcon');
        const femaleIcon = document.getElementById('femaleIcon');
        const maleIconWrapper = document.getElementById('maleIconWrapper');
        const femaleIconWrapper = document.getElementById('femaleIconWrapper');
        const resetButton = document.getElementById('resetButton');
        const dynamicResultsContentWrapper = document.getElementById('dynamicResultsContentWrapper'); // New wrapper for BMI results
        const dynamicIdealWeightRangeContentWrapper = document.getElementById('dynamicIdealWeightRangeContentWrapper'); // New wrapper for Ideal Weight Range

        // Category items for highlighting (left column)
        const categoryElements = {
            extremelyUnderweight: document.getElementById('categoryExtremelyUnderweight'),
            veryUnderweight: document.getElementById('categoryVeryUnderweight'),
            underweight: document.getElementById('categoryUnderweight'),
            normal: document.getElementById('categoryNormal'),
            overweight: document.getElementById('categoryOverweight'),
            obeseClassI: document.getElementById('categoryObeseClassI'),
            obeseClassII: document.getElementById('categoryObeseClassII'),
            obeseClassIII: document.getElementById('categoryObeseClassIII')
        };

        // Range display elements (right column - the span for the actual range text)
        const rangeElements = {
            extremelyUnderweight: document.getElementById('rangeExtremelyUnderweight'),
            veryUnderweight: document.getElementById('rangeVeryUnderweight'),
            underweight: document.getElementById('rangeUnderweight'),
            normal: document.getElementById('rangeNormal'),
            overweight: document.getElementById('rangeOverweight'),
            obeseClassI: document.getElementById('rangeObeseClassI'),
            obeseClassII: document.getElementById('rangeObeseClassII'),
            obeseClassIII: document.getElementById('rangeObeseClassIII')
        };

        // Parent div containers for the range elements (right column)
        const rangeItemElements = {
            extremelyUnderweight: document.getElementById('rangeItemExtremelyUnderweight'),
            veryUnderweight: document.getElementById('rangeItemVeryUnderweight'),
            underweight: document.getElementById('rangeItemUnderweight'),
            normal: document.getElementById('rangeItemNormal'),
            overweight: document.getElementById('rangeItemOverweight'),
            obeseClassI: document.getElementById('rangeItemObeseClassI'),
            obeseClassII: document.getElementById('rangeItemObeseClassII'),
            obeseClassIII: document.getElementById('rangeItemObeseClassIII')
        };

        let selectedGender = 'male'; // Default gender

        // BMI categories and ranges for adults, by region, and children
        const bmiRangesByRegion = {
            europe: { // General WHO Standards (European/Global)
                extremelyUnderweight: { min: 0, max: 15.9, text: "Cực kỳ Nhẹ cân" },
                veryUnderweight: { min: 16.0, max: 16.9, text: "Rất Nhẹ cân" },
                underweight: { min: 17.0, max: 18.4, text: "Nhẹ cân" },
                normal: { min: 18.5, max: 24.9, text: "Bình thường" },
                overweight: { min: 25.0, max: 29.9, text: "Thừa cân" },
                obeseClassI: { min: 30.0, max: 34.9, text: "Béo phì Loại I" },
                obeseClassII: { min: 35.0, max: 39.9, text: "Béo phì Loại II" },
                obeseClassIII: { min: 40.0, max: Infinity, text: "Béo phì Loại III" }
            },
            asia: { // WHO Asia-Pacific Standards (adapted to existing categories)
                extremelyUnderweight: { min: 0, max: 15.9, text: "Cực kỳ Nhẹ cân" },
                veryUnderweight: { min: 16.0, max: 18.4, text: "Rất Nhẹ cân" },
                underweight: { min: 17.0, max: 18.4, text: "Nhẹ cân" },
                normal: { min: 18.5, max: 22.9, text: "Bình thường" },
                overweight: { min: 23.0, max: 24.9, text: "Thừa cân" },
                obeseClassI: { min: 25.0, max: 29.9, text: "Béo phì Loại I" },
                obeseClassII: { min: 30.0, max: Infinity, text: "Béo phì Loại II" },
                obeseClassIII: { min: 9999, max: Infinity, text: "Béo phì Loại III" }
            },
            child: { // Simplified universal ranges for children (age < 18)
                underweight: { min: 0, max: 14.3, text: "Nhẹ cân" },
                normal: { min: 14.4, max: 21.1, text: "Bình thường" },
                overweight: { min: 21.2, max: 22.9, text: "Thừa cân" },
                obese: { min: 23.0, max: Infinity, text: "Béo phì" } // Added back "Obese" for children
            }
        };

        // This defines the segments and their labels for the horizontal BMI chart.
        const updateHorizontalChart = (isChild, region) => {
            let currentRanges;
            let orderedKeys;
            let maxChartBMI;
            // Determine the max BMI for scaling the chart visually
            if (isChild) {
                currentRanges = bmiRangesByRegion.child;
                orderedKeys = ['underweight', 'normal', 'overweight', 'obese'];
                maxChartBMI = 30; // Children's BMI charts usually don't go as high visually
            } else {
                currentRanges = bmiRangesByRegion[region];
                orderedKeys = ['extremelyUnderweight', 'veryUnderweight', 'underweight', 'normal', 'overweight', 'obeseClassI', 'obeseClassII', 'obeseClassIII'];
                maxChartBMI = 45; // Default max for adults
            }

            const bmiSegmentsDiv = document.querySelector('.bmi-track'); // This is the flex container
            const bmiLabelsDiv = document.querySelector('.bmi-horizontal-labels');

            // Clear existing segments and labels
            bmiSegmentsDiv.innerHTML = '';
            bmiLabelsDiv.innerHTML = '';

            // Set the background of the chart wrapper to the last (red) color
            // This acts as a fallback to cover any tiny gaps or rounding errors
            document.querySelector('.bmi-horizontal-chart').style.backgroundColor = '#dc2626'; // Red

            let previousMaxPercentage = 0; // Tracks the end of the previous segment in percentage

            // Iterate through ordered keys to create segments
            for (const key of orderedKeys) {
                const range = currentRanges[key];

                // Skip categories that are not relevant or are effectively hidden for specific regions/ages
                if (!range || (region === 'asia' && key === 'obeseClassIII' && range.min > 5000) ||
                    (isChild && !['underweight', 'normal', 'overweight', 'obese'].includes(key))) {
                    continue;
                }

                let segmentColor;
                if (['extremelyUnderweight', 'veryUnderweight', 'underweight'].includes(key)) {
                    segmentColor = '#60a5fa'; // Light blue
                } else if (key === 'normal') {
                    segmentColor = '#16a34a'; // Green
                } else if (key === 'overweight') {
                    segmentColor = '#ca8a04'; // Yellow
                } else { // All obesity classes (obese, obeseClassI, II, III)
                    segmentColor = '#dc2626'; // Red
                }

                const segmentStartValue = range.min;
                const segmentEndValue = range.max === Infinity ? maxChartBMI : range.max;

                // Calculate segment's start and end positions as percentages of the maxChartBMI
                let startPercentage = (segmentStartValue / maxChartBMI) * 100;
                let endPercentage = (segmentEndValue / maxChartBMI) * 100;

                // Ensure segments seamlessly connect by using previousMaxPercentage as the starting point
                // And prevent the segment from starting before the last one ended due to floating point inaccuracies.
                startPercentage = Math.max(startPercentage, previousMaxPercentage);


                const segmentWidthPercentage = endPercentage - startPercentage;

                if (segmentWidthPercentage > 0) {
                    const segmentDiv = document.createElement('div');
                    segmentDiv.className = 'bmi-segment';
                    segmentDiv.style.backgroundColor = segmentColor;
                    segmentDiv.style.width = `${segmentWidthPercentage}%`;
                    bmiSegmentsDiv.appendChild(segmentDiv);
                    previousMaxPercentage = endPercentage; // Update the end of this segment
                }
            }
            
            // Ensure the last segment added (which should be red if obesity is present)
            // stretches to fill any remaining space in the flex container
            const lastSegment = bmiSegmentsDiv.lastElementChild;
            if (lastSegment) {
                lastSegment.style.flexGrow = '1';
            }


            // Add labels dynamically for major breakpoints
            const addLabel = (value, className, displayValue = value.toFixed(1)) => {
                const labelSpan = document.createElement('span');
                labelSpan.className = `label-val ${className}`;
                labelSpan.textContent = displayValue;
                labelSpan.style.left = `${(value / maxChartBMI) * 100}%`;
                bmiLabelsDiv.appendChild(labelSpan);
            };

            // Common labels for all charts
            addLabel(0, 'label-min', '0');

            if (isChild) {
                addLabel(14.4, 'label-child-normal-start', '14.4');
                addLabel(21.1, 'label-child-normal-end', '21.1');
                addLabel(22.9, 'label-child-overweight-end', '22.9');
                addLabel(maxChartBMI, 'label-max', `${maxChartBMI}+`);
            } else if (region === 'asia') {
                addLabel(18.5, 'label-asia-normal-start', '18.5');
                addLabel(22.9, 'label-asia-normal-end', '22.9');
                addLabel(24.9, 'label-asia-overweight-end', '24.9');
                addLabel(29.9, 'label-asia-obese1-end', '29.9');
                addLabel(maxChartBMI, 'label-max', `${maxChartBMI}+`);
            } else { // europe
                addLabel(18.5, 'label-europe-normal-start', '18.5');
                addLabel(24.9, 'label-europe-normal-end', '24.9');
                addLabel(29.9, 'label-europe-overweight-end', '29.9');
                addLabel(34.9, 'label-europe-obese1-end', '34.9');
                addLabel(39.9, 'label-europe-obese2-end', '39.9');
                addLabel(maxChartBMI, 'label-max', `${maxChartBMI}+`);
            }
        };


        // Update BMI category ranges displayed in the table
        function updateCategoryRanges(isChild, region, currentBmiCategoryText = null) {
            const currentAdultRanges = bmiRangesByRegion[region];
            const currentChildRanges = bmiRangesByRegion.child;

            // Step 1: Hide and clear all category items regardless of age/region
            // Reset all category elements to their hidden, default state
            for (const key in categoryElements) {
                const catElem = categoryElements[key];
                const rangeItemElem = rangeItemElements[key];
                
                // Clear any specific color classes and selected class
                catElem.classList.remove('selected', 'underweight-color', 'normal-color', 'overweight-color', 'obese-color');
                rangeItemElem.classList.remove('selected', 'underweight-color', 'normal-color', 'overweight-color', 'obese-color');
                
                // Hide both the category name item and its range item
                catElem.style.display = 'none';
                rangeItemElem.style.display = 'none';
                
                // Clear text content
                const nameSpan = catElem.querySelector('.category-name');
                if (nameSpan) {
                    nameSpan.textContent = '';
                }
                const rangeSpan = rangeElements[key];
                if (rangeSpan) {
                    rangeSpan.textContent = '';
                }
            }

            // Step 2: Determine which categories to display and populate based on age/region
            let categoriesToProcess = [];
            if (isChild) {
                // For children, map to generic adult IDs that will be repurposed
                categoriesToProcess.push({ key: 'underweight', displayKey: 'underweight', text: 'Nhẹ cân', rangeData: currentChildRanges.underweight });
                categoriesToProcess.push({ key: 'normal', displayKey: 'normal', text: 'Bình thường', rangeData: currentChildRanges.normal });
                categoriesToProcess.push({ key: 'overweight', displayKey: 'overweight', text: 'Thừa cân', rangeData: currentChildRanges.overweight });
                categoriesToProcess.push({ key: 'obeseClassI', displayKey: 'obese', text: 'Béo phì', rangeData: currentChildRanges.obese }); // Repurpose obeseClassI for child obese
            } else { // Adults
                categoriesToProcess.push({ key: 'extremelyUnderweight', displayKey: 'extremelyUnderweight', text: 'Cực kỳ Nhẹ cân', rangeData: currentAdultRanges.extremelyUnderweight });
                categoriesToProcess.push({ key: 'veryUnderweight', displayKey: 'veryUnderweight', text: 'Rất Nhẹ cân', rangeData: currentAdultRanges.veryUnderweight });
                categoriesToProcess.push({ key: 'underweight', displayKey: 'underweight', text: 'Nhẹ cân', rangeData: currentAdultRanges.underweight });
                categoriesToProcess.push({ key: 'normal', displayKey: 'normal', text: 'Bình thường', rangeData: currentAdultRanges.normal });
                categoriesToProcess.push({ key: 'overweight', displayKey: 'overweight', text: 'Thừa cân', rangeData: currentAdultRanges.overweight });
                categoriesToProcess.push({ key: 'obeseClassI', displayKey: 'obeseClassI', text: 'Béo phì Loại I', rangeData: currentAdultRanges.obeseClassI });
                categoriesToProcess.push({ key: 'obeseClassII', displayKey: 'obeseClassII', text: 'Béo phì Loại II', rangeData: currentAdultRanges.obeseClassII });
                categoriesToProcess.push({ key: 'obeseClassIII', displayKey: 'obeseClassIII', text: 'Béo phì Loại III', rangeData: currentAdultRanges.obeseClassIII });
            }

            // Step 3: Populate and display only the relevant categories
            for (const item of categoriesToProcess) {
                const { key, displayKey, text, rangeData } = item;

                // Skip irrelevant categories for Asia adults if specified to be hidden
                if (!isChild && region === 'asia' && key === 'obeseClassIII' && rangeData && rangeData.min > 5000) {
                    continue;
                }
                
                const catElem = categoryElements[key]; // Get actual DOM element by its original ID key
                const rangeItemElem = rangeItemElements[key];
                const rangeSpan = rangeElements[key];

                if (catElem && rangeItemElem && rangeSpan) { // Ensure elements exist
                    catElem.style.display = 'flex'; // Display this element
                    rangeItemElem.style.display = 'flex'; // Display its corresponding range element

                    catElem.querySelector('.category-name').textContent = text; // Set the category name text

                    let rangeText = '';
                    if (rangeData) {
                        rangeText = `${rangeData.min.toFixed(1)} - ${rangeData.max === Infinity ? 'Trên' : rangeData.max.toFixed(1)}`;
                        // Special handling for child ranges' display text
                        if (isChild) {
                            if (displayKey === 'underweight') rangeText = `< ${bmiRangesByRegion.child.normal.min.toFixed(1)}`;
                            if (displayKey === 'obese') rangeText = `≥ ${rangeData.min.toFixed(1)}`;
                        } else { // Special handling for adult ranges' display text
                            if (key === 'extremelyUnderweight') rangeText = `< ${bmiRangesByRegion[region].veryUnderweight.min.toFixed(1)}`;
                            if (key === 'obeseClassIII') rangeText = `≥ ${rangeData.min.toFixed(1)}`;
                        }
                    }
                    rangeSpan.textContent = rangeText;

                    // Apply 'selected' class and color class only if this is the current BMI category
                    if (currentBmiCategoryText && text === currentBmiCategoryText) { // Compare with the actual displayed text
                        catElem.classList.add('selected');
                        rangeItemElem.classList.add('selected');

                        let finalColorClass = '';
                        if (['Cực kỳ Nhẹ cân', 'Rất Nhẹ cân', 'Nhẹ cân'].includes(text)) {
                            finalColorClass = 'underweight-color';
                        } else if (text === 'Bình thường') {
                            finalColorClass = 'normal-color';
                        } else if (text === 'Thừa cân') {
                            finalColorClass = 'overweight-color';
                        } else if (['Béo phì', 'Béo phì Loại I', 'Béo phì Loại II', 'Béo phì Loại III'].includes(text)) {
                            finalColorClass = 'obese-color';
                        }
                        catElem.classList.add(finalColorClass);
                        rangeItemElem.classList.add(finalColorClass);
                    }
                }
            }
        }


        // Function to calculate and display BMI
        function calculateBMI() {
            const age = parseInt(ageInput.value);
            let height = parseFloat(heightInput.value);
            let weight = parseFloat(weightInput.value);

            // Determine if inputs are valid for calculation
            const isValidInput = !isNaN(height) && !isNaN(weight) && height > 0 && weight > 0 && !isNaN(age) && age > 0;

            const isChild = age < 18;
            const currentRegion = regionSelect.value;
            
            // Default text and color for BMI results when not calculated
            let currentCategoryText = 'Vui lòng nhập đủ thông tin';
            let currentCategoryColorClass = 'text-gray-500'; // Default gray for invalid input
            let bmiValue = '0.0';
            let pointerPosition = '0%';
            let idealWeightText = '... kg';

            // Only update BMI results and ideal weight if inputs are valid
            if (isValidInput) {
                dynamicResultsContentWrapper.classList.remove('hidden');
                dynamicIdealWeightRangeContentWrapper.classList.remove('hidden');

                // Convert units to metric (cm and kg)
                if (heightUnit.value === 'm') {
                    height *= 100; // m to cm
                } else if (heightUnit.value === 'in') {
                    height *= 2.54; // inches to cm
                }

                if (weightUnit.value === 'lb') {
                    weight *= 0.453592; // lbs to kg
                }

                const bmi = weight / ((height / 100) ** 2);
                bmiValue = bmi.toFixed(1);

                let currentRanges;
                if (isChild) {
                    currentRanges = bmiRangesByRegion.child;
                    if (bmi < currentRanges.normal.min) {
                        currentCategoryText = currentRanges.underweight.text;
                        currentCategoryColorClass = 'text-blue-400'; // light blue for underweight
                    } else if (bmi >= currentRanges.normal.min && bmi <= currentRanges.normal.max) {
                        currentCategoryText = currentRanges.normal.text;
                        currentCategoryColorClass = 'text-green-600';
                    } else if (bmi >= currentRanges.overweight.min && bmi <= currentRanges.overweight.max) {
                        currentCategoryText = currentRanges.overweight.text;
                        currentCategoryColorClass = 'text-yellow-600'; // Changed to yellow
                    } else if (bmi >= currentRanges.obese.min) {
                        currentCategoryText = currentRanges.obese.text;
                        currentCategoryColorClass = 'text-red-600';
                    }
                } else { // Adults
                    currentRanges = bmiRangesByRegion[currentRegion];
                    for (const key in currentRanges) {
                        const range = currentRanges[key];
                        if (bmi >= range.min && bmi <= range.max) {
                            currentCategoryText = range.text;
                            if (['extremelyUnderweight', 'veryUnderweight', 'underweight'].includes(key)) {
                                currentCategoryColorClass = 'text-blue-400'; // light blue for underweight
                            } else if (key === 'normal') {
                                currentCategoryColorClass = 'text-green-600';
                            } else if (key === 'overweight') {
                                currentCategoryColorClass = 'text-yellow-600'; // Changed to yellow
                            } else { // All obesity classes
                                currentCategoryColorClass = 'text-red-600';
                            }
                            break;
                        }
                    }
                }
                
                // Update BMI pointer position
                const maxChartBMI = isChild ? 30 : 45; // Match with updateHorizontalChart's maxChartBMI
                let calculatedPointerPosition = (bmi / maxChartBMI) * 100;
                if (calculatedPointerPosition < 0) calculatedPointerPosition = 0;
                if (calculatedPointerPosition > 100) calculatedPointerPosition = 100;
                pointerPosition = `${calculatedPointerPosition}%`;

                // Calculate and display ideal weight range
                const idealWeightMin = (18.5 * (height / 100) ** 2).toFixed(1);
                const idealWeightMax = (24.9 * (height / 100) ** 2).toFixed(1);
                idealWeightText = `${idealWeightMin} - ${idealWeightMax} kg`;

            } else {
                // Hide the results section if inputs are not valid
                dynamicResultsContentWrapper.classList.add('hidden');
                dynamicIdealWeightRangeContentWrapper.classList.add('hidden');
            }

            // Update DOM elements for BMI results and ideal weight
            bmiResult.textContent = bmiValue;
            bmiCategory.textContent = currentCategoryText;
            bmiCategory.className = `bmi-category ${currentCategoryColorClass}`;
            bmiResult.className = `bmi-value ${currentCategoryColorClass}`;
            bmiPointer.style.left = pointerPosition;
            idealWeightRange.textContent = idealWeightText;


            // Update horizontal chart and category table based on current settings
            updateHorizontalChart(isChild, currentRegion);
            updateCategoryRanges(isChild, currentRegion, isValidInput ? currentCategoryText : null); // Pass currentCategoryText for highlighting only if valid input
        }

        // Gender selection logic
        maleIconWrapper.addEventListener('click', () => {
            maleIconWrapper.classList.add('selected');
            femaleIconWrapper.classList.remove('selected');
            selectedGender = 'male';
            calculateBMI();
        });

        femaleIconWrapper.addEventListener('click', () => {
            femaleIconWrapper.classList.add('selected');
            maleIconWrapper.classList.remove('selected');
            selectedGender = 'female';
            calculateBMI();
        });

        // Reset inputs and results
        resetButton.addEventListener('click', () => {
            ageInput.value = '';
            heightInput.value = '';
            weightInput.value = '';
            heightUnit.value = 'cm';
            weightUnit.value = 'kg';
            regionSelect.value = 'asia'; // Reset to default region
            maleIconWrapper.classList.add('selected'); // Reset gender selection
            femaleIconWrapper.classList.remove('selected');
            selectedGender = 'male';
            calculateBMI(); // Update display to initial state (hidden results)
        });

        // Event listeners for input changes
        const inputsAndSelects = [ageInput, heightInput, weightInput, heightUnit, weightUnit, regionSelect];
        inputsAndSelects.forEach(element => {
            element.addEventListener('input', calculateBMI);
            element.addEventListener('change', calculateBMI); // For select elements
        });

        // Double click to clear input fields
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('dblclick', () => {
                input.value = '';
            });
            input.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    calculateBMI();
                }
            });
        });

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            calculateBMI(); // Perform initial calculation to show default state (chart and table, but no results)
        });
    </script>
</body>
</html>
