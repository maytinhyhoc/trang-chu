<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Công Cụ Y Học - NEWS2</title> 
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FONTS & ICONS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ICONS & PWA -->
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" type="image/png" href="logo.png">

    <style>
        /* --- APP FEEL OPTIMIZATIONS (CHUẨN) --- */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6; 
            padding-bottom: 80px; /* Space for Bottom Nav */
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none; /* Ngăn chọn text toàn trang */
            user-select: none;
            touch-action: pan-x pan-y;
        }

        /* Cho phép chọn text ở input và kết quả */
        .result-text, input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }

        /* Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translate3d(0, 20px, 0); }
            to { opacity: 1; transform: translate3d(0, 0, 0); }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out;
        }
        
        /* Tùy chỉnh thanh cuộn nếu cần */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* Custom Radio Button Style từ file cũ */
        .custom-radio:checked + label {
            background-color: #e0e7ff;
            border-color: #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
    </style>
</head>
<body>

    <!-- DESKTOP HEADER -->
    <header class="hidden md:flex fixed top-0 w-full bg-white shadow-sm z-50 h-16 items-center px-8 justify-between">
        <div class="flex items-center gap-3">
            <img src="logo.png" onerror="this.src='https://raw.githubusercontent.com/maytinhyhoc/trang-chu/main/logo.png'" alt="Logo" class="w-10 h-10 object-contain">
            <h1 class="text-xl md:text-3xl font-bold text-blue-600">Máy Tính Y Học</h1>
        </div>
        <nav class="flex gap-8 text-sm md:text-lg font-medium text-gray-600">
            <a href="index.html" class="hover:text-teal-600 transition">Trang chủ</a>
            <a href="cong-cu.html" class="text-teal-600 font-bold">Công cụ</a>
            <a href="#" onclick="openDrawer(event)" class="hover:text-teal-600 transition">Khác</a>
        </nav>
    </header>

    <!-- MOBILE HEADER (App Style) -->
    <header class="md:hidden fixed top-0 left-0 right-0 bg-white shadow-sm z-40 h-[60px] flex items-center px-4">
        <a href="cong-cu.html" class="p-2 -ml-2 text-gray-600 hover:text-indigo-600 transition">
            <i class="fa-solid fa-chevron-left text-lg"></i>
        </a>
        <h1 class="flex-1 text-center text-lg font-bold text-gray-800 truncate px-2">
            NEWS2 Score
        </h1>
        <div class="w-8"></div> <!-- Spacer để căn giữa tiêu đề -->
    </header>

    <!-- MAIN CONTENT WRAPPER -->
    <main class="flex-grow container mx-auto px-4 pt-20 md:pt-24 pb-4 max-w-4xl">
        <!-- KHỐI CARD CHÍNH CỦA CÔNG CỤ -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden animate-fade-in-up">
            
            <!-- HEADER CỦA CARD (DESKTOP) -->
            <div class="hidden md:flex bg-indigo-600 p-6 text-white items-center justify-between">
                <div class="flex items-center">
                    <!-- Nút Back Desktop -->
                    <a href="cong-cu.html" class="hidden md:flex w-10 h-10 rounded-full bg-indigo-500 hover:bg-indigo-400 items-center justify-center text-white transition shadow-sm mr-4">
                        <i class="fa-solid fa-chevron-left"></i>
                    </a>
                    <div>
                        <h1 class="text-2xl font-bold">Thang điểm NEWS2</h1>
                        <p class="text-indigo-100 mt-1 text-sm">National Early Warning Score 2 - Đánh giá cảnh báo sớm mức độ bệnh nặng.</p>
                    </div>
                </div>
                <!-- Icon đại diện mờ -->
                <i class="fa-solid fa-heart-pulse text-4xl text-indigo-300 opacity-50"></i>
            </div>

            <!-- FORM TÍNH TOÁN -->
            <div class="p-4 md:p-8">
                <!-- Nội dung form NEWS2 -->
                <form id="tool-form" class="space-y-6 md:space-y-8" novalidate>
                    
                    <!-- 1. Nhịp thở -->
                    <div>
                        <label for="rr" class="block text-sm font-semibold text-gray-700 mb-2">1. Nhịp thở (lần/phút)</label>
                        <input type="number" id="rr" name="rr" placeholder="VD: 18" class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm outline-none text-lg" inputmode="numeric">
                    </div>
    
                    <!-- 2. SpO2 -->
                    <div class="bg-indigo-50/50 p-4 rounded-xl border border-indigo-100">
                        <div class="flex items-center justify-between mb-2">
                            <label for="spo2" class="block text-sm font-semibold text-gray-700">2. SpO2 (%)</label>
                            <div class="flex items-center">
                                <input type="checkbox" id="copd" name="copd" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="copd" class="ml-2 text-xs font-medium text-red-600 cursor-pointer select-none">Bệnh nhân COPD (Thang 2)</label>
                            </div>
                        </div>
                        <input type="number" id="spo2" name="spo2" placeholder="VD: 96" class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm outline-none text-lg" inputmode="numeric">
                        <p id="scale-hint" class="text-xs text-gray-500 mt-2 flex items-center gap-1">
                            <i class="fa-solid fa-circle-info"></i> <span>Sử dụng Thang 1 (Mặc định)</span>
                        </p>
                    </div>
    
                    <!-- 3. Thở Oxy -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">3. Hỗ trợ Oxy?</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <input type="radio" id="air" name="oxygen" value="air" class="hidden custom-radio">
                                <label for="air" class="block w-full text-center px-4 py-3 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 transition bg-white text-gray-600">Không khí phòng</label>
                            </div>
                            <div>
                                <input type="radio" id="o2" name="oxygen" value="o2" class="hidden custom-radio">
                                <label for="o2" class="block w-full text-center px-4 py-3 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 transition bg-white text-gray-600">Có thở Oxy</label>
                            </div>
                        </div>
                    </div>
    
                    <!-- 4. Huyết áp tâm thu -->
                    <div>
                        <label for="sys_bp" class="block text-sm font-semibold text-gray-700 mb-2">4. Huyết áp tâm thu (mmHg)</label>
                        <input type="number" id="sys_bp" name="sys_bp" placeholder="VD: 120" class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm outline-none text-lg" inputmode="numeric">
                    </div>
    
                    <!-- 5. Mạch -->
                    <div>
                        <label for="pulse" class="block text-sm font-semibold text-gray-700 mb-2">5. Mạch (lần/phút)</label>
                        <input type="number" id="pulse" name="pulse" placeholder="VD: 80" class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm outline-none text-lg" inputmode="numeric">
                    </div>
    
                    <!-- 6. Tri giác -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">6. Tri giác (AVPU)</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <input type="radio" id="alert" name="avpu" value="alert" class="hidden custom-radio">
                                <label for="alert" class="block w-full text-center px-4 py-3 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 transition bg-white text-gray-600">Tỉnh táo (Alert)</label>
                            </div>
                            <div>
                                <input type="radio" id="cvpu" name="avpu" value="cvpu" class="hidden custom-radio">
                                <label for="cvpu" class="block w-full text-center px-4 py-3 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 transition bg-white text-gray-600">C / V / P / U</label>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1 ml-1">C: Mới lú lẫn, V: Đáp ứng lời nói, P: Đáp ứng đau, U: Không đáp ứng</p>
                    </div>
    
                    <!-- 7. Nhiệt độ -->
                    <div>
                        <label for="temp" class="block text-sm font-semibold text-gray-700 mb-2">7. Nhiệt độ (°C)</label>
                        <input type="number" id="temp" name="temp" placeholder="VD: 37.0" step="0.1" class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm outline-none text-lg" inputmode="decimal">
                    </div>
                    
                    <div class="pt-4 flex flex-col sm:flex-row gap-4">
                        <button type="submit" class="flex-1 bg-indigo-600 text-white font-bold py-3.5 px-6 rounded-xl shadow-md hover:shadow-lg transition duration-300 active:scale-95 flex items-center justify-center text-lg">
                            <i class="fa-solid fa-calculator mr-2"></i> Tính toán
                        </button>
                        <button type="button" id="clearBtn" class="flex-1 bg-white text-red-500 border border-red-200 font-bold py-3.5 px-6 rounded-xl shadow-sm hover:shadow-md transition duration-300 hover:bg-red-50 flex items-center justify-center">
                            <i class="fa-solid fa-rotate-right mr-2"></i> Làm mới
                        </button>
                    </div>
                </form>
    
                <!-- KẾT QUẢ -->
                <div id="result-container" class="mt-8 hidden animate-fade-in-up">
                    <div class="bg-indigo-50 border border-indigo-100 rounded-2xl p-6 text-center shadow-inner relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-2 opacity-10">
                            <i class="fa-solid fa-file-medical text-6xl text-indigo-600"></i>
                        </div>
                        <h3 class="text-xs font-bold text-indigo-500 uppercase tracking-wider mb-2">Điểm NEWS2</h3>
                        <div id="main-result" class="text-6xl font-black text-indigo-700 mb-3 tracking-tighter">--</div>
                        
                        <div id="risk-badge" class="inline-block px-4 py-1.5 rounded-full text-sm font-bold mb-6 bg-gray-200 text-gray-700 shadow-sm">
                            Chưa đánh giá
                        </div>
    
                        <div class="bg-white/80 rounded-xl p-4 text-left border border-indigo-100 shadow-sm">
                            <p id="sub-result" class="result-text text-gray-800 leading-relaxed text-sm">
                                ...
                            </p>
                        </div>
                    </div>
                </div>

                <!-- MÔ TẢ & CHỈ ĐỊNH (MỚI) -->
                <div class="mt-10 pt-8 border-t border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-circle-info text-indigo-600 mr-2"></i> Thông tin & Chỉ định
                    </h3>
                    <div class="text-gray-600 text-sm space-y-4 leading-relaxed">
                        <div>
                            <span class="font-bold text-gray-700 block mb-1">Mô tả:</span>
                            <p>NEWS2 (National Early Warning Score 2) là hệ thống chấm điểm cảnh báo sớm chuẩn hóa, được sử dụng để đánh giá mức độ bệnh nặng và phát hiện sớm tình trạng suy giảm lâm sàng ở bệnh nhân cấp tính.</p>
                        </div>
                        
                        <div>
                            <span class="font-bold text-gray-700 block mb-1">Chỉ định:</span>
                            <ul class="list-disc pl-5 space-y-1 marker:text-indigo-500">
                                <li>Theo dõi sinh hiệu thường quy cho bệnh nhân nội trú người lớn (≥ 16 tuổi).</li>
                                <li>Đánh giá ban đầu tại khoa Cấp cứu, Khám bệnh.</li>
                                <li>Theo dõi tiền phẫu và hậu phẫu.</li>
                            </ul>
                        </div>

                        <div class="bg-orange-50 p-4 rounded-xl border border-orange-100">
                            <span class="font-bold text-orange-800 block mb-1"><i class="fa-solid fa-triangle-exclamation mr-1"></i> Lưu ý & Chống chỉ định:</span>
                            <ul class="list-disc pl-5 space-y-1 text-orange-700 marker:text-orange-500">
                                <li><strong>Thang SpO2 2:</strong> Chỉ áp dụng cho bệnh nhân suy hô hấp tăng carbonic (như COPD) với đích SpO2 88-92%.</li>
                                <li><strong>Không áp dụng cho:</strong> Trẻ em dưới 16 tuổi, phụ nữ mang thai (khuyên dùng MEOWS), bệnh nhân tổn thương tủy sống (do rối loạn thần kinh tự chủ).</li>
                            </ul>
                        </div>
                        
                        <div class="text-xs text-gray-400 italic pt-2">
                            Nguồn: Royal College of Physicians (UK). National Early Warning Score (NEWS) 2.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- DRAWER MENU -->
    <div id="drawer-overlay" onclick="closeDrawer()" class="fixed inset-0 bg-black/50 z-[60] hidden transition-opacity opacity-0"></div>
    <div id="drawer-menu" class="fixed top-0 right-0 h-full w-72 bg-white shadow-2xl z-[70] transform transition-transform translate-x-full duration-300 ease-in-out flex flex-col">
        <div class="p-5 flex justify-between items-center border-b border-gray-100 bg-gray-50">
            <h2 class="font-bold text-xl text-gray-800">Menu</h2>
            <button onclick="closeDrawer()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 text-gray-500 transition"><i class="fa-solid fa-xmark text-lg"></i></button>
        </div>
        <div class="p-4 flex flex-col gap-2 overflow-y-auto flex-1">
            <a href="gioi-thieu.html" class="flex items-center gap-4 p-3 hover:bg-teal-50 hover:text-teal-600 rounded-xl transition group text-gray-700">
                <div class="w-8 h-8 rounded-full bg-teal-100 flex items-center justify-center text-teal-600 group-hover:scale-110 transition"><i class="fa-solid fa-circle-info"></i></div>
                <span class="font-medium">Giới thiệu</span>
            </a>
            <a href="lien-he.html" class="flex items-center gap-4 p-3 hover:bg-green-50 hover:text-green-600 rounded-xl transition group text-gray-700">
                <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-600 group-hover:scale-110 transition"><i class="fa-solid fa-envelope"></i></div>
                <span class="font-medium">Liên hệ</span>
            </a>
            <a href="dieu-khoan-dich-vu.html" class="flex items-center gap-4 p-3 hover:bg-blue-50 hover:text-blue-600 rounded-xl transition group text-gray-700">
                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 group-hover:scale-110 transition"><i class="fa-solid fa-file-contract"></i></div>
                <span class="font-medium">Điều khoản</span>
            </a>
            <a href="chinh-sach-bao-mat.html" class="flex items-center gap-4 p-3 hover:bg-purple-50 hover:text-purple-600 rounded-xl transition group text-gray-700">
                <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 group-hover:scale-110 transition"><i class="fa-solid fa-shield-halved"></i></div>
                <span class="font-medium">Chính sách</span>
            </a>
            <div class="my-2 border-t border-gray-100"></div>
            <a href="ung-ho.html" class="flex items-center gap-4 p-3 hover:bg-rose-50 hover:text-rose-600 rounded-xl transition group text-gray-700">
                <div class="w-8 h-8 rounded-full bg-rose-100 flex items-center justify-center text-rose-600 group-hover:scale-110 transition"><i class="fa-solid fa-heart"></i></div>
                <span class="font-medium">Ủng hộ</span>
            </a>
        </div>
    </div>

    <!-- MOBILE BOTTOM NAV -->
    <nav class="md:hidden fixed bottom-0 left-0 z-50 w-full h-16 bg-white border-t border-gray-100 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <div class="grid h-full max-w-lg grid-cols-3 mx-auto font-medium">
            <a href="index.html" class="nav-item text-gray-500 inline-flex flex-col items-center justify-center px-5 group hover:text-teal-600">
                <i class="fa-solid fa-house text-xl mb-1 group-hover:text-teal-600"></i>
                <span class="text-[10px] group-hover:text-teal-600">Trang chủ</span>
            </a>
            <a href="cong-cu.html" class="nav-item active text-teal-600 inline-flex flex-col items-center justify-center px-5 group">
                <i class="fa-solid fa-calculator text-xl mb-1"></i>
                <span class="text-[10px]">Công cụ</span>
            </a>
            <button type="button" onclick="openDrawer(event)" class="nav-item text-gray-500 inline-flex flex-col items-center justify-center px-5 group hover:text-teal-600">
                <i class="fa-solid fa-bars text-xl mb-1 group-hover:text-teal-600"></i>
                <span class="text-[10px] group-hover:text-teal-600">Khác</span>
            </button>
        </div>
    </nav>

    <!-- NOTIFICATION MODAL -->
    <div id="notification-modal" class="fixed inset-0 flex items-center justify-center z-[80] hidden">
        <div class="absolute inset-0 bg-black/50 transition-opacity" onclick="hideModal()"></div>
        <div class="bg-white rounded-xl shadow-xl p-6 relative z-10 w-11/12 max-w-sm text-center transform transition-all scale-100 animate-fade-in-up">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <i class="fa-solid fa-triangle-exclamation text-red-600 text-xl"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-900 mb-2">Thông báo</h3>
            <p id="modal-message" class="text-sm text-gray-500 mb-6">Nội dung thông báo...</p>
            <button onclick="hideModal()" class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none transition">
                Đóng
            </button>
        </div>
    </div>

    <script>
        // --- 1. LOGIC LƯU LỊCH SỬ ---
        function useTool(id, name, icon, color, url) {
            let recentTools = JSON.parse(localStorage.getItem('recentTools')) || [];
            recentTools = recentTools.filter(tool => tool.id !== id);
            recentTools.unshift({
                id: id,
                name: name,
                icon: icon,
                color: color,
                url: url,
                timestamp: new Date().getTime()
            });
            if (recentTools.length > 5) recentTools.pop();
            localStorage.setItem('recentTools', JSON.stringify(recentTools));
        }

        // --- 2. LOGIC DRAWER MENU ---
        function openDrawer(e) {
            if(e) e.preventDefault();
            const drawer = document.getElementById('drawer-menu');
            const overlay = document.getElementById('drawer-overlay');
            overlay.classList.remove('hidden');
            setTimeout(() => overlay.classList.remove('opacity-0'), 10);
            drawer.classList.remove('translate-x-full');
            document.body.style.overflow = 'hidden';
        }

        function closeDrawer() {
            const drawer = document.getElementById('drawer-menu');
            const overlay = document.getElementById('drawer-overlay');
            drawer.classList.add('translate-x-full');
            overlay.classList.add('opacity-0');
            setTimeout(() => {
                overlay.classList.add('hidden');
                document.body.style.overflow = '';
            }, 300);
        }

        // --- 3. LOGIC MODAL ---
        const modal = document.getElementById('notification-modal');
        const modalMessage = document.getElementById('modal-message');

        window.showModal = function(message) {
            if(modal && modalMessage) {
                modalMessage.textContent = message;
                modal.classList.remove('hidden');
            }
        }

        window.hideModal = function() {
            if(modal) modal.classList.add('hidden');
        }

        // --- 4. KHỞI TẠO & LOGIC CÔNG CỤ NEWS2 ---
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('tool-form');
            const resultContainer = document.getElementById('result-container');
            const mainResult = document.getElementById('main-result');
            const subResult = document.getElementById('sub-result');
            const riskBadge = document.getElementById('risk-badge');
            const clearBtn = document.getElementById('clearBtn');
            const copdCheckbox = document.getElementById('copd');
            const scaleHint = document.getElementById('scale-hint');

            // UI Toggle cho COPD
            copdCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    scaleHint.innerHTML = '<i class="fa-solid fa-triangle-exclamation text-red-500"></i> <span class="text-red-600 font-bold">Thang 2 (Suy hô hấp tăng carbonic)</span>';
                } else {
                    scaleHint.innerHTML = '<i class="fa-solid fa-circle-info"></i> <span>Sử dụng Thang 1 (Mặc định)</span>';
                }
            });

            // Xử lý Submit
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 1. Get Values
                const rr = document.getElementById('rr').value;
                const spo2 = document.getElementById('spo2').value;
                const isCOPD = document.getElementById('copd').checked;
                const oxygenRadio = document.querySelector('input[name="oxygen"]:checked');
                const sys_bp = document.getElementById('sys_bp').value;
                const pulse = document.getElementById('pulse').value;
                const avpuRadio = document.querySelector('input[name="avpu"]:checked');
                const temp = document.getElementById('temp').value;

                // 2. Validation
                if (rr === '' || spo2 === '' || !oxygenRadio || sys_bp === '' || pulse === '' || !avpuRadio || temp === '') {
                    showModal("Vui lòng nhập đầy đủ các chỉ số sinh hiệu.");
                    return;
                }

                const rrVal = parseFloat(rr);
                const spo2Val = parseFloat(spo2);
                const sysBpVal = parseFloat(sys_bp);
                const pulseVal = parseFloat(pulse);
                const tempVal = parseFloat(temp);
                const oxygenVal = oxygenRadio.value; // 'air' or 'o2'
                const avpuVal = avpuRadio.value; // 'alert' or 'cvpu'

                // Basic Logic Sanity Check
                if (rrVal < 0 || spo2Val < 0 || spo2Val > 100 || sysBpVal < 0 || pulseVal < 0 || tempVal < 10 || tempVal > 50) {
                     showModal("Một số chỉ số không hợp lệ (ngoài giới hạn sinh lý).");
                     return;
                }

                // 3. Calculation Logic
                let score = 0;
                let redScore = false; // Flag for single parameter scoring 3

                function addScore(points) {
                    score += points;
                    if (points === 3) redScore = true;
                }

                // RR
                if (rrVal <= 8) addScore(3);
                else if (rrVal >= 9 && rrVal <= 11) addScore(1);
                else if (rrVal >= 12 && rrVal <= 20) addScore(0);
                else if (rrVal >= 21 && rrVal <= 24) addScore(2);
                else if (rrVal >= 25) addScore(3);

                // SpO2
                if (!isCOPD) {
                    if (spo2Val <= 91) addScore(3);
                    else if (spo2Val >= 92 && spo2Val <= 93) addScore(2);
                    else if (spo2Val >= 94 && spo2Val <= 95) addScore(1);
                    else addScore(0);
                } else {
                    if (spo2Val <= 83) addScore(3);
                    else if (spo2Val >= 84 && spo2Val <= 87) addScore(2);
                    else if (spo2Val >= 88 && spo2Val <= 92) addScore(0);
                    else if (spo2Val >= 93 && spo2Val <= 94) {
                        oxygenVal === 'o2' ? addScore(1) : addScore(0);
                    }
                    else if (spo2Val >= 95 && spo2Val <= 96) {
                         oxygenVal === 'o2' ? addScore(2) : addScore(0);
                    }
                    else if (spo2Val >= 97) {
                        oxygenVal === 'o2' ? addScore(3) : addScore(0);
                    }
                }

                // Oxygen
                if (oxygenVal === 'o2') addScore(2); else addScore(0);

                // Sys BP
                if (sysBpVal <= 90) addScore(3);
                else if (sysBpVal >= 91 && sysBpVal <= 100) addScore(2);
                else if (sysBpVal >= 101 && sysBpVal <= 110) addScore(1);
                else if (sysBpVal >= 111 && sysBpVal <= 219) addScore(0);
                else if (sysBpVal >= 220) addScore(3);

                // Pulse
                if (pulseVal <= 40) addScore(3);
                else if (pulseVal >= 41 && pulseVal <= 50) addScore(1);
                else if (pulseVal >= 51 && pulseVal <= 90) addScore(0);
                else if (pulseVal >= 91 && pulseVal <= 110) addScore(1);
                else if (pulseVal >= 111 && pulseVal <= 130) addScore(2);
                else if (pulseVal >= 131) addScore(3);

                // AVPU
                if (avpuVal === 'alert') addScore(0); else addScore(3);

                // Temp
                if (tempVal <= 35.0) addScore(3);
                else if (tempVal >= 35.1 && tempVal <= 36.0) addScore(1);
                else if (tempVal >= 36.1 && tempVal <= 38.0) addScore(0);
                else if (tempVal >= 38.1 && tempVal <= 39.0) addScore(1);
                else if (tempVal >= 39.1) addScore(2);

                // 4. Result
                mainResult.textContent = score;
                
                let riskLevel = "";
                let riskClass = "";
                let message = "";

                if (score >= 0 && score <= 4 && !redScore) {
                    riskLevel = "Nguy cơ THẤP";
                    riskClass = "bg-green-100 text-green-800 border border-green-200";
                    message = "Theo dõi lâm sàng dựa trên năng lực điều dưỡng. Tần suất theo dõi tối thiểu 12 giờ/lần.";
                } else if ((score >= 0 && score <= 4 && redScore) || score === 3) {
                    riskLevel = "Nguy cơ THẤP - TRUNG BÌNH";
                    riskClass = "bg-yellow-100 text-yellow-800 border border-yellow-200";
                    message = "Cần phản hồi khẩn cấp từ điều dưỡng chăm sóc hoặc bác sĩ. Tần suất theo dõi tối thiểu 4-6 giờ/lần. Có 1 chỉ số đạt 3 điểm.";
                } else if (score >= 5 && score <= 6) {
                    riskLevel = "Nguy cơ TRUNG BÌNH";
                    riskClass = "bg-orange-100 text-orange-800 border border-orange-200";
                    message = "Ngưỡng quan trọng. Cần phản hồi khẩn cấp từ bác sĩ lâm sàng hoặc đội cấp cứu. Tần suất theo dõi tối thiểu 1 giờ/lần.";
                } else if (score >= 7) {
                    riskLevel = "Nguy cơ CAO";
                    riskClass = "bg-red-100 text-red-800 border border-red-200";
                    message = "Cần phản hồi khẩn cấp hoặc cấp cứu. Xem xét chuyển ICU hoặc kích hoạt đội phản ứng nhanh. Theo dõi liên tục.";
                }

                // Simplified Logic override matching previous logic structure
                if (score >= 7) {
                     riskLevel = "Nguy cơ CAO";
                     riskClass = "bg-red-100 text-red-800 border border-red-200";
                } else if (score >= 5) {
                     riskLevel = "Nguy cơ TRUNG BÌNH";
                     riskClass = "bg-orange-100 text-orange-800 border border-orange-200";
                } else if (redScore) {
                     riskLevel = "Nguy cơ THẤP - TRUNG BÌNH";
                     riskClass = "bg-yellow-100 text-yellow-800 border border-yellow-200";
                } else {
                     riskLevel = "Nguy cơ THẤP";
                     riskClass = "bg-green-100 text-green-800 border border-green-200";
                }

                riskBadge.className = `inline-block px-4 py-1.5 rounded-full text-sm font-bold mb-6 shadow-sm ${riskClass}`;
                riskBadge.textContent = riskLevel;
                subResult.innerHTML = `<strong><i class="fa-solid fa-user-doctor"></i> Khuyến nghị:</strong> ${message}`;

                resultContainer.classList.remove('hidden');
                
                // Save History
                useTool('news2', 'Thang điểm NEWS2', 'fa-heart-pulse', 'text-indigo-600', window.location.href);

                // Auto Scroll
                const headerHeight = document.querySelector('header')?.offsetHeight || 0;
                const targetPos = resultContainer.getBoundingClientRect().top + window.pageYOffset - headerHeight - 20;
                window.scrollTo({ top: targetPos, behavior: 'smooth' });
            });

            // Xử lý nút Clear
            clearBtn.addEventListener('click', function() {
                form.reset();
                resultContainer.classList.add('hidden');
                mainResult.textContent = "--";
                riskBadge.className = "inline-block px-4 py-1 rounded-full text-sm font-bold mb-6 bg-gray-200 text-gray-700 shadow-sm";
                riskBadge.textContent = "Chưa đánh giá";
                scaleHint.innerHTML = '<i class="fa-solid fa-circle-info"></i> <span>Sử dụng Thang 1 (Mặc định)</span>';
            });
        });

        // --- BẢO VỆ SOURCE CODE ---
        document.addEventListener('contextmenu', function(e) { e.preventDefault(); });
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'u' || e.key === 'a' || e.key === 'p')) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>