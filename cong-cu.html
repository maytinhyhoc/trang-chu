<!DOCTYPE html>
<html lang="vi">

<head>
    <script src="settings.js"></script>
    <script src="protection.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Danh sách công cụ - Máy tính Y học</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <meta name="theme-color" content="#0d9488">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="manifest" href="/manifest.json">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { primary: '#0ea5e9', secondary: '#14b8a6' },
                    animation: { 'float': 'float 6s ease-in-out infinite' },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- CHẶN BÔI ĐEN (SELECTION) --- */
        body {
            -webkit-tap-highlight-color: transparent;
            touch-action: pan-x pan-y;
            overscroll-behavior-y: none;

            overscroll-behavior-y: none;
        }

        .bg-pattern {
            background-color: #f8fafc;
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* Vẫn cho phép bôi đen/chọn trong ô input để người dùng gõ tìm kiếm */
        input {
            -webkit-user-select: text !important;
            user-select: text !important;
            cursor: auto;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .search-glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body
    class="text-slate-800 bg-pattern min-h-screen pb-24 md:pb-8 overflow-x-hidden selection:bg-primary selection:text-white">

    <div
        class="fixed top-0 left-0 w-full h-96 bg-gradient-to-b from-blue-50/80 to-transparent -z-10 pointer-events-none">
    </div>
    <div
        class="fixed -top-20 -right-20 w-96 h-96 bg-blue-100/50 rounded-full blur-3xl -z-10 pointer-events-none mix-blend-multiply animate-float">
    </div>
    <div class="fixed top-1/2 -left-20 w-80 h-80 bg-teal-100/40 rounded-full blur-3xl -z-10 pointer-events-none mix-blend-multiply animate-float"
        style="animation-delay: 2s;"></div>
    <div class="fixed bottom-0 right-0 w-96 h-96 bg-purple-100/40 rounded-full blur-3xl -z-10 pointer-events-none mix-blend-multiply animate-float"
        style="animation-delay: 4s;"></div>

    <main class="md:pt-20 p-3 md:p-6 max-w-6xl mx-auto min-h-screen">

        <div class="md:hidden pt-2 pb-4 flex items-center justify-between relative z-20">
            <div>
                <h2 class="text-xs text-slate-500 font-bold uppercase tracking-widest mb-1 text-dark-muted">Thư viện
                </h2>
                <h1
                    class="text-2xl font-extrabold bg-gradient-to-r from-blue-600 to-teal-500 bg-clip-text text-transparent">
                    Tất cả công cụ</h1>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="window.location.reload()"
                    class="w-10 h-10 flex items-center justify-center rounded-xl bg-white shadow-sm border border-slate-100 text-slate-500 hover:text-blue-600 active:scale-95 transition"><i
                        class="fa-solid fa-rotate-right"></i></button>
                <a href="index.html"
                    class="w-10 h-10 flex items-center justify-center rounded-xl bg-white shadow-sm border border-slate-100 text-slate-500 hover:text-blue-600 active:scale-95 transition"><i
                        class="fa-solid fa-arrow-left"></i></a>
            </div>
        </div>

        <div class="sticky top-0 md:top-20 z-40 -mx-3 px-3 md:mx-0 md:px-0 py-3 mb-6 transition-all duration-300"
            id="search-container">
            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none z-10">
                    <i
                        class="fa-solid fa-magnifying-glass text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
                </div>
                <input type="text" id="search-input" onkeyup="filterTools()"
                    placeholder="Tìm nhanh (VD: bỏng, gcs, liều...)"
                    class="w-full pl-11 pr-4 py-3.5 rounded-2xl border-none shadow-[0_4px_20px_-4px_rgba(0,0,0,0.1)] search-glass focus:ring-2 focus:ring-blue-500/50 focus:outline-none text-slate-700 text-base placeholder:text-slate-400 transition-all">
            </div>
        </div>

        <div id="library-container" class="min-h-[50vh]">
            <div class="flex flex-col items-center justify-center pt-20 text-slate-400">
                <i class="fa-solid fa-spinner fa-spin text-3xl mb-4 text-blue-500"></i>
                <p>Đang tải dữ liệu y khoa...</p>
            </div>
        </div>

    </main>

    <script>
        // --- LOGIC TIM (YÊU THÍCH) ---
        async function handleHeartClick(btn, id, name, url, icon, color) {

            // 1. UI Optimistic Update (Đổi màu ngay để tạo cảm giác mượt)
            const iconEl = btn.querySelector('i');
            const isFav = iconEl.classList.contains('fa-solid');
            const oldClass = iconEl.className; // Lưu lại class cũ để hoàn tác nếu lỗi

            if (isFav) {
                iconEl.className = 'fa-regular fa-heart text-slate-300 group-hover/btn:text-red-500 transition-colors';
            } else {
                iconEl.className = 'fa-solid fa-heart text-red-500 transition-colors';
            }

            // 2. GỌI HÀM XỬ LÝ CHÍNH
            if (window.toggleFavorite) {
                try {
                    await window.toggleFavorite(id, name, url, icon, color);
                } catch (error) {
                    // Nếu app.js báo lỗi (ví dụ: chưa đăng nhập), hoàn tác lại màu icon
                    iconEl.className = oldClass;
                    console.log("Hoàn tác UI do lỗi:", error.message);
                }
            } else {
                // Trường hợp app.js chưa tải xong
                console.log("Hệ thống chưa sẵn sàng, vui lòng đợi...");
                iconEl.className = oldClass;
            }
        }

        // --- CÁC HÀM HỖ TRỢ KHÁC ---
        window.loadFavorites = function (uid) {
            if (window.getUserFavorites) {
                window.getUserFavorites(function (favorites) {
                    document.querySelectorAll('.fav-btn i').forEach(i => {
                        i.className = 'fa-regular fa-heart text-slate-300 group-hover/btn:text-red-500 transition-colors';
                    });
                    favorites.forEach(item => {
                        const btn = document.querySelector(`.fav-btn[data-id="${item.id}"]`);
                        if (btn) {
                            btn.querySelector('i').className = 'fa-solid fa-heart text-red-500 transition-colors';
                        }
                    });
                });
            }
        }

        function useTool(id, name, icon, color, url) {
            let recentTools = JSON.parse(localStorage.getItem('recentTools')) || [];
            recentTools = recentTools.filter(tool => tool.url !== url && tool.id !== id);
            recentTools.unshift({
                id: id, name: name, icon: icon, color: color, url: url,
                timestamp: new Date().getTime()
            });
            if (recentTools.length > 5) recentTools = recentTools.slice(0, 5);
            localStorage.setItem('recentTools', JSON.stringify(recentTools));
            cleanToolsList();

            if (url) {
                document.body.style.opacity = '0.7';
                document.body.style.transition = 'opacity 0.2s';
                setTimeout(() => window.location.href = url, 100);
            } else {
                alert('Trang này chưa sẵn sàng!');
            }
        }

        function cleanToolsList() {
            let recentTools = JSON.parse(localStorage.getItem('recentTools')) || [];
            if (recentTools.length === 0) return;
            const uniqueTools = [];
            const seenIds = new Set();
            for (const tool of recentTools) {
                const safeId = (tool.id || '').trim();
                if (!seenIds.has(safeId)) {
                    seenIds.add(safeId);
                    uniqueTools.push(tool);
                }
            }
            localStorage.setItem('recentTools', JSON.stringify(uniqueTools));
        }

        document.addEventListener('DOMContentLoaded', () => {
            cleanToolsList();
            const searchContainer = document.getElementById('search-container');
            window.addEventListener('scroll', () => {
                if (window.scrollY > 10) {
                    searchContainer.classList.add('shadow-sm');
                } else {
                    searchContainer.classList.remove('shadow-sm');
                }
            });

            // --- TỰ ĐỘNG TÌM KIẾM TỪ URL PARAMS ---
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('q') || urlParams.get('search');
            if (query) {
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.value = query;
                    // Đợi 1 chút để tools-data.js render xong (dù đã gọi ở cuối body, nhưng an toàn hơn)
                    setTimeout(() => {
                        if (typeof filterTools === 'function') filterTools();
                    }, 100);
                }
            }


        });
    </script>

    <script src="tools-data.js"></script>

    <script type="module" src="app.js"></script>
</body>

</html>